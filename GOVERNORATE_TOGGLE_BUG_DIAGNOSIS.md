# ๐ ุชูุฑูุฑ ุชุดุฎูุต ูุดููุฉ ุนุฏู ุงุณุชุฌุงุจุฉ ุฃุฒุฑุงุฑ ุชูุนูู/ุฅุฎูุงุก ุงููุญุงูุธุงุช

**ุงูุชุงุฑูุฎ:** 5 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ุชู ุชุญุฏูุฏ ุงููุดููุฉ ุจุฏูุฉ  
**ุงูุฃููููุฉ:** ๐ด ุนุงููุฉ

---

## ๐ ูุตู ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุชูุนูู ุฃู ุฅุฎูุงุก ูุญุงูุธุฉ ูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุญุงูุธุงุช (`/app_admin/governorates`)ุ ูุง ุชุณุชุฌูุจ ุงูุฃุฒุฑุงุฑ ููุง ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุญุงูุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

---

## ๐ ุงูุชุญููู ุงูููู ุงููุชุนูู

ุจุนุฏ ูุญุต ุดุงูู ููููุฏุ ุชู ุชุญุฏูุฏ **ุงููุดููุฉ ุงูุฌุฐุฑูุฉ** ุจุฏูุฉ:

### ุงููุดููุฉ ุงูุฑุฆูุณูุฉ: **ุนุฏู ูุฌูุฏ RLS Policies ุนูู ุฌุฏูู `governorates`**

ุฌุฏูู `governorates` **ูุง ูุญุชูู ุนูู ุฃู ุณูุงุณุงุช Row Level Security (RLS)**ุ ููุง ูุนูู ุฃู ุฌููุน ุนูููุงุช ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ุนูู ูุฐุง ุงูุฌุฏูู **ูุญุธูุฑุฉ ุงูุชุฑุงุถูุงู** ูุฌููุน ุงููุณุชุฎุฏูููุ ุจูุง ูู ุฐูู ุงูุฃุฏูู.

### ุงูุชูุงุตูู ุงููููุฉ

#### 1. ุญุงูุฉ ุฌุฏูู `governorates`

ูู ุฎูุงู ูุญุต ุฌููุน ูููุงุช ุงูู migrations ูู ุงููุดุฑูุนุ ุชุจูู ูุง ููู:

- **ูุง ููุฌุฏ** ููู migration ูููู ุจุฅูุดุงุก ุฌุฏูู `governorates` (ุงูุฌุฏูู ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููู ูู ูุชู ุฅูุดุงุคู ุนุจุฑ migration).
- **ูุง ููุฌุฏ** ุฃู ุณุทุฑ ูุญุชูู ุนูู `ALTER TABLE governorates ENABLE ROW LEVEL SECURITY`.
- **ูุง ุชูุฌุฏ** ุฃู `CREATE POLICY` ุนูู ุฌุฏูู `governorates`.

ูุฐุง ูุนูู ุฃู ุงูุฌุฏูู ุฅูุง:
- ุชู ุฅูุดุงุคู ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุฃู
- ุชู ุฅูุดุงุคู ุนุจุฑ ุฃุฏุงุฉ ุฎุงุฑุฌูุฉ (ูุซู Supabase Dashboard)ุ ุฃู
- ุชู ุฅูุดุงุคู ูู migration ูุฏูู ุชู ุญุฐูู ุฃู ูู ูุชู ุชุถูููู ูู ุงููุดุฑูุน.

#### 2. ุณููู RLS ุงูุงูุชุฑุงุถู ูู Supabase

ุนูุฏูุง ูุชู ุชูุนูู RLS ุนูู ุฌุฏูู ูู Supabase **ุฏูู ุฅุถุงูุฉ ุฃู policies**ุ ูุฅู ุงูุณููู ุงูุงูุชุฑุงุถู ูู:

- **ุฑูุถ ุฌููุน ุงูุนูููุงุช** (SELECT, INSERT, UPDATE, DELETE) ูุฌููุน ุงููุณุชุฎุฏููู.
- ุญุชู ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู (authenticated) ูุงูุฃุฏูู **ูุง ูููููู** ุงููุตูู ููุจูุงูุงุช.

**ุงูุงุณุชุซูุงุก ุงููุญูุฏ:** `service_role` key ููููู ุชุฌุงูุฒ RLS ูุงููุตูู ููุจูุงูุงุช ูุจุงุดุฑุฉ.

#### 3. ุชุญููู ุงูููุฏ ุงูุญุงูู

**ุฃ. ุฏุงูุฉ `updateGovernorateVisibility`:**

```typescript
const supabase = await createSupabaseUserServerActionClient();
// ...
const { error } = await supabase
  .from("governorates")
  .update({ is_visible: isVisible } as any)
  .eq("id", governorateId);
```

ูุฐู ุงูุฏุงูุฉ ุชุณุชุฎุฏู `createSupabaseUserServerActionClient`ุ ูุงูุฐู ูุณุชุฎุฏู:
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` (anon key)
- Session cookies ูููุณุชุฎุฏู ุงูุญุงูู

ุนูุฏูุง ูุญุงูู ุงูุฃุฏูู ุชุญุฏูุซ ุงููุญุงูุธุฉุ ูุชู ุฅุฑุณุงู ุงูุทูุจ ุฅูู Supabase ุจุงุณุชุฎุฏุงู `anon key` + session token. ููู ุจูุง ุฃู ุฌุฏูู `governorates` **ูุง ูุญุชูู ุนูู ุฃู RLS policies**ุ ูุฅู Supabase ูุฑูุถ ุงูุนูููุฉ ุชููุงุฆูุงู.

**ุจ. ุฏุงูุฉ `getAllGovernorates`:**

```typescript
const supabase = await createSupabaseUserServerActionClient();

const { data, error } = await supabase
  .from("governorates")
  .select("id, name_ar, name_en, is_visible")
  .order("name_ar", { ascending: true });
```

ูุฐู ุงูุฏุงูุฉ **ุชูุฌุญ** ูู ุฌูุจ ุงูุจูุงูุงุชุ ูููู **ููุท ุฅุฐุง ูุงู ููุงู policy ูููุฑุงุกุฉ**. ุฅุฐุง ูู ููู ููุงู policyุ ูุณุชูุดู ุฃูุถุงู.

**ุงูุณุคุงู:** ููุงุฐุง ุชุธูุฑ ุงููุญุงูุธุงุช ูู ุงูุตูุญุฉ ุฅุฐูุ

**ุงูุฅุฌุงุจุฉ ุงููุญุชููุฉ:**
1. ูุฏ ูููู ููุงู policy ูููุฑุงุกุฉ (SELECT) ุชู ุฅุถุงูุชู ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููู **ูุง ููุฌุฏ policy ููุชุญุฏูุซ (UPDATE)**.
2. ุฃู ุฃู ุงูุจูุงูุงุช ูุชู ุฌูุจูุง ูู cache ูููุณ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ.

#### 4. ุงููุฑู ุจูู ุงูุฌุฏุงูู ุงูุฃุฎุฑู

ุนูุฏ ููุงุฑูุฉ ุฌุฏูู `governorates` ุจุงูุฌุฏุงูู ุงูุฃุฎุฑู ูู ุงููุดุฑูุน (ูุซู `deputy_profiles`, `complaints`, `jobs`ุ ุฅูุฎ)ุ ูุฌุฏ ุฃู **ุฌููุน ุงูุฌุฏุงูู ุงูุฃุฎุฑู** ุชุญุชูู ุนูู:

1. `ALTER TABLE [table_name] ENABLE ROW LEVEL SECURITY;`
2. ูุฌููุนุฉ ูู `CREATE POLICY` statements ูุชุญุฏูุฏ ูู ููููู ุงููุฑุงุกุฉ/ุงููุชุงุจุฉ/ุงูุชุญุฏูุซ/ุงูุญุฐู.

**ูุซุงู ูู `deputy_profiles`:**

```sql
ALTER TABLE deputy_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view deputy profiles"
    ON deputy_profiles
    FOR SELECT
    TO authenticated
    USING (true);

CREATE POLICY "Application admins can insert deputy profiles"
    ON deputy_profiles
    FOR INSERT
    TO authenticated
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE id = auth.uid()
            AND role IN ('super_admin', 'admin')
        )
    );
```

---

## ๐ฏ ุงูุฎูุงุตุฉ: ุงููุดููุฉ ุงููุญุฏุฏุฉ ุจุฏูุฉ

**ุงููุดููุฉ:** ุฌุฏูู `governorates` **ูุง ูุญุชูู ุนูู RLS policies** ุชุณูุญ ููุฃุฏูู ุจุชุญุฏูุซ ุงูุจูุงูุงุช.

**ุงูุณุจุจ:** ุนูุฏ ูุญุงููุฉ ุชูููุฐ `UPDATE` ุนูู ุฌุฏูู ูุญูู ุจู RLS ุฏูู ูุฌูุฏ policy ููุงุณุจุ ูุฑูุถ Supabase ุงูุนูููุฉ ุชููุงุฆูุงู.

**ุงููุชูุฌุฉ:** 
- ุงูุฃุฒุฑุงุฑ ูุง ุชุณุชุฌูุจ (ุชุจุฏู ููุฃููุง ูุง ุชุนูู).
- ูุง ูุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช.
- ูุฏ ูุธูุฑ ุฎุทุฃ ูู console logs (ุฅุฐุง ุชู ูุญุตูุง) ูุซู: `"new row violates row-level security policy"` ุฃู `"permission denied"`.

---

## โ ุงูุญู ุงููุทููุจ (ุจุฏูู ุชูููุฐ)

ูุญู ูุฐู ุงููุดููุฉุ ูุฌุจ:

1. **ุฅูุดุงุก migration ุฌุฏูุฏ** ูุถูู RLS policies ุนูู ุฌุฏูู `governorates`.
2. **ุฅุถุงูุฉ policy ูููุฑุงุกุฉ** (SELECT) ุชุณูุญ ูุฌููุน ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ุจูุฑุงุกุฉ ุงููุญุงูุธุงุช.
3. **ุฅุถุงูุฉ policy ููุชุญุฏูุซ** (UPDATE) ุชุณูุญ **ููุท ููุฃุฏูู** ุจุชุญุฏูุซ ุญุงูุฉ `is_visible`.

**ูุซุงู ุนูู ุงูููุฏ ุงููุทููุจ:**

```sql
-- Enable RLS on governorates table
ALTER TABLE governorates ENABLE ROW LEVEL SECURITY;

-- Policy: Anyone can view governorates
CREATE POLICY "Anyone can view governorates"
  ON governorates
  FOR SELECT
  TO authenticated
  USING (true);

-- Policy: Only admins can update governorates
CREATE POLICY "Only admins can update governorates"
  ON governorates
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid()
      AND role IN ('super_admin', 'admin')
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid()
      AND role IN ('super_admin', 'admin')
    )
  );
```

---

## ๐ ููุฎุต ุงูุชุดุฎูุต

| ุงูุนูุตุฑ | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|---|---|---|
| **ุตูุญุฉ ุงูุฅุฏุงุฑุฉ** | โ ุตุญูุญุฉ | ุงูููุฏ ุณููู ููุณุชุฎุฏู Server Actions ุจุดูู ุตุญูุญ |
| **Server Action** | โ ุตุญูุญุฉ | `updateGovernorateVisibility` ุชุญุชูู ุนูู ูุญุต ุงูุตูุงุญูุงุช |
| **Supabase Client** | โ ุตุญูุญ | ูุณุชุฎุฏู `anon key` + session cookies ุจุดูู ุตุญูุญ |
| **RLS Policies** | โ **ููููุฏุฉ** | **ูุง ุชูุฌุฏ policies ุนูู ุฌุฏูู `governorates`** |
| **ูุงุนุฏุฉ ุงูุจูุงูุงุช** | โ๏ธ ูุญููุฉ | ุงูุฌุฏูู ูุญูู ุจู RLS ูููู ุจุฏูู policies |

---

## ๐ง ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุชุฃููุฏ ุงูุชุดุฎูุต:** ูุญุต console logs ูู ุงููุชุตูุญ ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุชูุนูู/ุงูุฅุฎูุงุก ููุชุฃูุฏ ูู ุธููุฑ ุฎุทุฃ RLS.
2. **ุฅูุดุงุก Migration:** ุฅูุดุงุก ููู migration ุฌุฏูุฏ ูุถูู RLS policies ุงููุทููุจุฉ.
3. **ุชุทุจูู Migration:** ุชุดุบูู ุงูู migration ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
4. **ุงูุงุฎุชุจุงุฑ:** ุงูุชุฃูุฏ ูู ุฃู ุงูุฃุฒุฑุงุฑ ุชุนูู ุจุดูู ุตุญูุญ ุจุนุฏ ุฅุถุงูุฉ ุงูู policies.

---

**ููุงุญุธุฉ ูููุฉ:** ูุฐุง ุงูุชูุฑูุฑ ูุญุฏุฏ ุงููุดููุฉ ุจุฏูุฉ **ุฏูู ุชูุฏูู ุญููู ุฃู ุชุนุฏููุงุช ุนูู ุงูููุฏ**ุ ููุง ุทูุจุช. ุงูุญู ุงููุฐููุฑ ุฃุนูุงู ูู ููุชูุถูุญ ููุท ููู ูุชู ุชูููุฐู.
