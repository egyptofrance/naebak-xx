# ุดุฑุญ: ููู ูููู ุงููุตูู ูููุญุฉ ุงูุฃุฏูู ุจุฏูู ุตูุงุญูุงุช adminุ

## โ ุงูุณุคุงู
"ุงุฒุงู ุงูุญุณุงุจ ุจุชุงุนู ูุด ุงุฏูู ู ุงูููุญู ุจุชุงุนุชู ููุญู ุงุฏููุ"

---

## โ ุงูุฅุฌุงุจุฉ

ููุฌุฏ **ูุธุงูุงู ูููุตูุงู** ููุชุญูู ูู ุตูุงุญูุงุช ุงูุฃุฏูู ูู ุงููุดุฑูุน:

### 1๏ธโฃ ุงูุชุญูู ูู ุงููุตูู ูููุญุฉ ุงูุฃุฏูู (Middleware)

**ุงูููู:** `src/middlewares/admin-middleware.ts`
**ุงูุฏุงูุฉ:** `isSupabaseUserAppAdmin(user)`

```typescript
export function isSupabaseUserAppAdmin(user: User): boolean {
  if (user.app_metadata && "user_role" in user.app_metadata) {
    return user.app_metadata.user_role === "admin";
  }
  return false;
}
```

**ูุชุญูู ูู:** `user.app_metadata.user_role === "admin"`

**ุงููููุน:** ูู ุฌุฏูู `auth.users` โ ุญูู `app_metadata`

---

### 2๏ธโฃ ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุนูููุงุช (Server Actions)

**ุงูููู:** `src/app/actions/governorate/updateGovernorateVisibility.ts`

```typescript
const { data: profile } = await supabase
  .from("user_profiles")
  .select("role")
  .eq("id", user.id)
  .single();

if (!profile || !["super_admin", "admin", "manager"].includes(profile.role)) {
  return { success: false, error: "ุบูุฑ ูุตุฑุญ - ูุฌุจ ุฃู ุชููู ูุณุคููุงู" };
}
```

**ูุชุญูู ูู:** `user_profiles.role` ูู `["super_admin", "admin", "manager"]`

**ุงููููุน:** ูู ุฌุฏูู `user_profiles` โ ุญูู `role`

---

## ๐ ุงูููุงุฑูุฉ

| ุงูุฌุงูุจ | Middleware (ุงููุตูู ูููุญุฉ) | Server Actions (ุงูุนูููุงุช) |
|---|---|---|
| **ุงูุฌุฏูู** | `auth.users` | `user_profiles` |
| **ุงูุญูู** | `app_metadata.user_role` | `role` |
| **ุงููููุฉ ุงููุทููุจุฉ** | `"admin"` | `["super_admin", "admin", "manager"]` |
| **ุงูุบุฑุถ** | ุงูุณูุงุญ ุจุงูุฏุฎูู ูููุญุฉ ุงูุฃุฏูู | ุงูุณูุงุญ ุจุชูููุฐ ุนูููุงุช ูุนููุฉ |

---

## ๐ฏ ููุงุฐุง ูุฐุง ุงูุชุตูููุ

### ููุฒุงุช ูุฐุง ุงููุธุงู:

1. **ูุตู ุงูุตูุงุญูุงุช**
   - ูููู ุงูุณูุงุญ ูุดุฎุต ุจุงูุฏุฎูู ูููุญุฉ ุงูุฃุฏูู (ูููุดุงูุฏุฉ ููุท)
   - ููู ููุนู ูู ุชูููุฐ ุนูููุงุช ุญุณุงุณุฉ

2. **ูุฑููุฉ ูู ุงูุชุญูู**
   - `app_metadata` ููุฏุงุฑ ูู Supabase Dashboard ุฃู Auth Hooks
   - `user_profiles.role` ููุฏุงุฑ ูู ุงูุชุทุจูู ููุณู

3. **ุฃูุงู ูุชุนุฏุฏ ุงูุทุจูุงุช**
   - ุญุชู ูู ุฏุฎู ุดุฎุต ูููุญุฉ ุงูุฃุฏููุ ูุง ููููู ุชูููุฐ ุนูููุงุช ุจุฏูู ุตูุงุญูุงุช

---

## ๐ง ุงูุญู ูู ุญุงูุชู

### ุงููุถุน ุงูุญุงูู:
- โ `app_metadata.user_role = "admin"` โ **ููููู ุงูุฏุฎูู ูููุญุฉ ุงูุฃุฏูู**
- โ `user_profiles.role = "citizen"` โ **ูุง ููููู ุชูููุฐ ุนูููุงุช**

### ุจุนุฏ ุงูุชุนุฏูู:
- โ `app_metadata.user_role = "admin"` โ **ููููู ุงูุฏุฎูู ูููุญุฉ ุงูุฃุฏูู**
- โ `user_profiles.role = "manager"` โ **ููููู ุชูููุฐ ุนูููุงุช** (ุจุนุฏ ุชุนุฏูู ุงูููุฏ)

---

## ๐ ุงูุชูุตูุงุช

### ูููุณุชูุจู:

1. **ุชูุญูุฏ ุงููุธุงู**
   - ุงุณุชุฎุฏุงู `user_profiles.role` ููุท ูู ูู ููุงู
   - ุฃู ุงุณุชุฎุฏุงู `app_metadata.user_role` ููุท

2. **ุฅุถุงูุฉ middleware ููุนูููุงุช**
   - ุงูุชุญูู ูู `user_profiles.role` ูู middleware ุฃูุถุงู
   - ูููุน ุงููุตูู ูุตูุญุงุช ูุนููุฉ ุจูุงุกู ุนูู ุงูุฏูุฑ

3. **ุฅุถุงูุฉ UI permissions**
   - ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ุงูุชู ูุง ูููู ูููุณุชุฎุฏู ุงุณุชุฎุฏุงููุง
   - ุจูุงุกู ุนูู `user_profiles.role`

---

## ๐ ุงูุฎูุงุตุฉ

**ุงูุณุจุจ:** ููุฌุฏ ูุธุงูุงู ูููุตูุงู - ูุงุญุฏ ูููุตูู (Middleware) ููุงุญุฏ ููุนูููุงุช (Server Actions).

**ุงูุญู ุงูููุทุจู:** 
1. โ ุชุญุฏูุซ `user_profiles.role` ุฅูู `"manager"`
2. โ ุชุนุฏูู Server Action ูููุจู `"manager"` ูุตูุงุญูุฉ admin
3. โ ุงูุขู ููููู ุงูุฏุฎูู **ู** ุชูููุฐ ุงูุนูููุงุช

---

ุชุงุฑูุฎ ุงูุชูุซูู: 2025-11-05
