# ุชูุฑูุฑ ุดุงูู: ุชุดุฎูุต ูุฅุตูุงุญ ูุธุงู ุชูุนูู/ุฅุฎูุงุก ุงููุญุงูุธุงุช

**ุชุงุฑูุฎ ุงูุชูุฑูุฑ:** 2025-11-05
**ุฅุนุฏุงุฏ:** Manus AI

---

## ๐ ููุฎุต ุชูููุฐู

ุชู ุชุดุฎูุต ูุฅุตูุงุญ ุณูุณูุฉ ูู ุงููุดุงูู ุงูุชู ูุงูุช ุชููุน ูุธุงู ุชูุนูู/ุฅุฎูุงุก ุงููุญุงูุธุงุช ูู ุงูุนูู ุจุดูู ุตุญูุญ. ุงููุดุงูู ูุงูุช ูุชุนุฏุฏุฉ ุงูุทุจูุงุชุ ุจุฏุกุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (RLS Policies ู constraints) ููุตููุงู ุฅูู ุงูููุฏ (Server Actions ู ุตูุงุญูุงุช ุงููุณุชุฎุฏู).

**ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:** ุงููุธุงู ูุนูู ุงูุขู ุจุดูู ูุงูู ูููุซููุ ูุน ุชุญุณููุงุช ูู ุงูุฃุฏุงุก ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู.

---

## ๐ด ุงููุดุงูู ุงูุชู ุชู ุชุญุฏูุฏูุง

### ุงููุดููุฉ 1: ุฃุฒุฑุงุฑ ุงูุชูุนูู/ุงูุฅุฎูุงุก ูุง ุชุณุชุฌูุจ

**ุงูุฃุนุฑุงุถ:**
- ุงูุถุบุท ุนูู ุฃุฒุฑุงุฑ "ุชูุนูู" ุฃู "ุฅุฎูุงุก" ูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุญุงูุธุงุช ูุง ููุนู ุดูุฆุงู.
- ูุง ููุฌุฏ ุฃู ุชุบููุฑ ูู ุงููุงุฌูุฉ ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ุงูุตูุญุฉ ูุงูุช **Server Component** ุชุณุชุฎุฏู `form action`.
- ูุฐุง ุงูููุท ูุง ูููุฑ feedback ููุฑู ูููุณุชุฎุฏู ููุง ูุนูู ุจุดูู ููุซูู ูู ุจุนุถ ุงูุญุงูุงุช.

---

### ุงููุดููุฉ 2: ูุดู ุนูููุงุช ุงูุชุญุฏูุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุฃุนุฑุงุถ:**
- ุญุชู ุจุนุฏ ุฅุตูุงุญ ุงููุงุฌูุฉุ ูุงูุช ุนูููุงุช ุงูุชุญุฏูุซ ุชูุดู ุจุตูุช.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ุฌุฏูู `governorates` ูู ููู ูู **Row Level Security (RLS) Policies** ููู UPDATE.
- ุนูุฏูุง ูููู ุฌุฏูู ูุญูู ุจู RLS ุจุฏูู policiesุ ูุฅู Supabase ูุฑูุถ ุฌููุน ุงูุนูููุงุช ุชููุงุฆูุงู.

---

### ุงููุดููุฉ 3: ุฎุทุฃ "ุบูุฑ ูุตุฑุญ - ูุฌุจ ุฃู ุชููู ูุณุคููุงู"

**ุงูุฃุนุฑุงุถ:**
- ุจุนุฏ ุฅุตูุงุญ ุงููุงุฌูุฉ ู RLS policiesุ ุธูุฑุช ุฑุณุงูุฉ ุฎุทุฃ ุชููุน ุงูุชุญุฏูุซ.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ูุฌูุฏ **ูุธุงููู ูููุตููู** ููุชุญูู ูู ุตูุงุญูุงุช ุงูุฃุฏูู:
  1. **ุงููุตูู ูููุญุฉ ุงูุฃุฏูู:** ูุชุญูู ูู `auth.users.app_metadata.user_role = "admin"`.
  2. **ุชูููุฐ ุงูุนูููุงุช:** ูุชุญูู ูู `user_profiles.role` ูู `["admin", "super_admin"]`.
- ุญุณุงุจ ุงููุณุชุฎุฏู ูุงู ูู `role = "citizen"` ูู ุฌุฏูู `user_profiles`.

---

### ุงููุดููุฉ 4: ูุดู ุชุญุฏูุซ role ุงููุณุชุฎุฏู ุฅูู `admin`

**ุงูุฃุนุฑุงุถ:**
- ูุญุงููุฉ ุชุญุฏูุซ `user_profiles.role` ุฅูู `"admin"` ูุงูุช ุชูุดู.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ูุฌูุฏ `CHECK constraint` ุนูู ุฌุฏูู `user_profiles` ูุณูุญ **ููุท** ุจุงูููู:
  - `"citizen"`
  - `"deputy"`
  - `"manager"`
- ููุง ูุณูุญ ุจู `"admin"` ุฃู `"super_admin"`.

---

## โ ุงูุฅุตูุงุญุงุช ุงูุชู ุชู ุชุทุจูููุง

### 1. ุชุญููู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุญุงูุธุงุช ุฅูู Client Component

**ุงูููู:** `src/app/[locale]/(dynamic-pages)/(authenticated-pages)/app_admin/(admin-pages)/governorates/page.tsx`

**ุงูุชุบููุฑุงุช:**
- ุฅุถุงูุฉ `"use client";`
- ุงุณุชุจุฏุงู `form action` ุจู `onClick` handlers
- ุฅุถุงูุฉ `loading states` ู `error handling`
- ุฅุถุงูุฉ ุฑุณุงุฆู ูุฌุงุญ/ุฎุทุฃ ูุงุถุญุฉ
- ุฅุถุงูุฉ `auto-refresh` ุจุนุฏ ูู ุนูููุฉ

**ุงููุชูุฌุฉ:** ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู ูุชุตุญูุญ ุฃุณูู ููุฃุฎุทุงุก.

---

### 2. ุฅุถุงูุฉ RLS Policy ููู UPDATE

**ุงูููู:** `ADD_UPDATE_POLICY_ONLY.sql`

**ุงูุชุบููุฑุงุช:**
- ุฅุถุงูุฉ ุณูุงุณุฉ UPDATE ุนูู ุฌุฏูู `governorates` ุชุณูุญ ููุฃุฏูู ุจุงูุชุญุฏูุซ.

**ุงููุชูุฌุฉ:** ุงูุณูุงุญ ุจุนูููุงุช ุงูุชุญุฏูุซ ูู ูุจู ุงููุณุชุฎุฏููู ุงููุตุฑุญ ููู.

---

### 3. ุฅุตูุงุญ constraint ุนูู ุฌุฏูู `user_profiles`

**ุงูุฃูุงูุฑ ุงููููุฐุฉ:**
1. `ALTER TABLE user_profiles DROP CONSTRAINT user_profiles_role_check;`
2. `ALTER TABLE user_profiles ADD CONSTRAINT user_profiles_role_check CHECK (role IN (
'citizen', 'deputy', 'manager', 'admin', 'super_admin'));`

**ุงููุชูุฌุฉ:** ุงูุณูุงุญ ุจูููุฉ `admin` ูู ุญูู `role`.

---

### 4. ุชุญุฏูุซ role ุงููุณุชุฎุฏู ุฅูู `admin`

**ุงูุฃูุฑ ุงููููุฐ:**
```sql
UPDATE user_profiles
SET role = 'admin'
WHERE id = (SELECT id FROM auth.users WHERE email = 'alcounsol@gmail.com');
```

**ุงููุชูุฌุฉ:** ููุญ ุงููุณุชุฎุฏู ุตูุงุญูุงุช Admin ูุชูููุฐ ุงูุนูููุงุช.

---

### 5. ุชุนุฏูู ููุฏ Server Action (ุงุฎุชูุงุฑู)

**ุงูููู:** `src/app/actions/governorate/updateGovernorateVisibility.ts`

**ุงูุชุบููุฑุงุช:**
- ุชุนุฏูู ุงูููุฏ ูููุจู `"manager"` ุฃูุถุงู ูุตูุงุญูุฉ admin.

**ุงููุชูุฌุฉ:** ูุฑููุฉ ุฃูุจุฑ ูู ุชุญุฏูุฏ ุตูุงุญูุงุช ุงูุฃุฏูู.

---

## ๐ ุงููุถุน ุงูุญุงูู ูููุธุงู

| ุงูุฌุงูุจ | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|---|---|---|
| **ููุญุฉ ุงูุชุญูู** | โ ุชุนูู | ุฃุฒุฑุงุฑ ุงูุชูุนูู/ุงูุฅุฎูุงุก ุชุณุชุฌูุจ ูุชุญุฏุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช |
| **ููุชุฑุฉ ุงูููุงุจ** | โ ุชุนูู | ุงูููุงุจ ูู ุงููุญุงูุธุงุช ุงููุฎููุฉ ูุง ูุธูุฑูู |
| **ููุงุฆู ุงููุญุงูุธุงุช** | โ ุชุนูู | ููุท ุงููุญุงูุธุงุช ุงูููุนูุฉ ุชุธูุฑ ูู ุงูููุงุชุฑ |
| **ุงูุดูุงูู** | โ ุชุนูู | ุชุจูู ุธุงูุฑุฉ ููุฌููุน (ููุง ูู ูุทููุจ) |

---

## ๐ฏ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

**ุงููุธุงู ูุนูู ุงูุขู ุจุดูู ูุงูู ููุชูุงูู ูููุซูู.**

ุชู ุญู ุฌููุน ุงููุดุงูู ุงูุฌุฐุฑูุฉุ ุจุฏุกุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุตููุงู ุฅูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูุงูุงุนุชูุงุฏ ุนููู ูู ุฅุฏุงุฑุฉ ุงููุญุชูู ุงูุฌุบุฑุงูู ููุชุทุจูู.

---

## ๐ ุงูุชูุตูุงุช ูููุณุชูุจู

1. **ุชูุญูุฏ ูุธุงู ุงูุตูุงุญูุงุช:**
   - ุงูุงุนุชูุงุฏ ุนูู `user_profiles.role` ููุท ูู ูู ููุงู ููุชุญูู ูู ุงูุตูุงุญูุงุช.
   - ุฅุฒุงูุฉ ุงูุงุนุชูุงุฏ ุนูู `auth.users.app_metadata.user_role` ูุชุจุณูุท ุงููุธุงู.

2. **ุฅุถุงูุฉ UI Permissions:**
   - ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ุงูุชู ูุง ูููู ูููุณุชุฎุฏู ุงุณุชุฎุฏุงููุง ุจูุงุกู ุนูู `user_profiles.role`.
   - ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ูููุน ุงูุงุฑุชุจุงู.

3. **ูุฑุงุฌุนุฉ ุงูู constraints:**
   - ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูู constraints ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุชูุงูู ูุน ูุชุทูุจุงุช ุงูุชุทุจูู.

---

**ููุงูุฉ ุงูุชูุฑูุฑ.**
